<class name="literal" export>
  <script>
    binding.original = '';
    binding.setValue = function(v) {
      binding.original = v;
      binding.element.innerText = v.toString();
    };
    binding.getValue = function() {
      return binding.original;
    };
  </script>
</class>

<class name="list" export>
  <class name="index">
    <script>
      var index = namespace.get('LIST(INDEX)');
      binding.element.innerText = index.toString();
      namespace.setAtDefinition('LIST(INDEX)', index + 1);
//console.log(namespace);
    </script>
  </class>
  <script>
    binding.listPart = document.createElement('SPAN');

    namespace.set('LIST(INDEX)', 1);

    if ('add' in binding.attributes) {
      binding.listPart = document.createElement('SPAN');
      binding.addPart = document.createElement('SPAN');
      binding.element.appendChild(binding.listPart);
      binding.element.appendChild(binding.addPart);

      var button = document.createElement('BUTTON');
      button.innerText = '+';
      button.addEventListener('click', function(evt) {
        var contentTag = document.createElement('CONTENT');
        binding.listPart.appendChild(contentTag);

        interpretTag(contentTag, namespace)
          .then(function(elementBindings, scripts) {
            binding.addToModel(elementBindings);
            binding.runScripts(scripts);

            if ('delete' in binding.attributes) {
              binding.appendDeleteButton(elementBindings[0]);
            }

            binding.notifyChange();
            elementBindings[0].focus();
          });
      });
      binding.addPart.appendChild(button);
    } else {
      binding.listPart = binding.element;
    }

    binding.getValue = function() {
      var result = [];
      for (var i = 0; i < binding.unnamed.length; ++i) {
        result.push(binding.unnamed[i].getValue());
      }
      return result;
    };

    binding.setValue = function(v) {
      binding.unnamed = [];
      binding.listPart.innerHTML = '';

      var prefix = null;
      var prefixFunction = null;
      if ('prefix' in binding.attributes) {
        try {
          eval('var fn = function(index) {return '
            + binding.attributes.prefix + ';}');
          prefixFunction = fn;
        } catch (ignore) {
          prefix = binding.attributes.prefix;
        }
      }

      for (var i = 0; i < v.length; ++i) {
        if (('delimiter' in binding.attributes) && (i > 0)) {
          var span = document.createElement('SPAN');
          span.innerHTML = binding.attributes.delimiter;
          binding.listPart.appendChild(span);
        }

        if (prefixFunction != null) {
          var span = document.createElement('SPAN');
          span.innerHTML = prefixFunction(i).toString();
          binding.listPart.appendChild(span);
        } else if (prefix != null) {
          var span = document.createElement('SPAN');
          span.innerHTML = prefix;
          binding.listPart.appendChild(span);
        }

        var contentTag = document.createElement('CONTENT');
        binding.listPart.appendChild(contentTag);

        interpretTag(contentTag, namespace)
          .then(function(elementBindings, scripts) {
            binding.addToModel(elementBindings);
            binding.runScripts(scripts);

            if ('delete' in binding.attributes) {
              binding.appendDeleteButton(elementBindings[0]);
            }

            elementBindings[0].setValue(v[i]);
          });
      }
    };

    binding.appendDeleteButton = function(elementBinding) {
      var button = document.createElement('BUTTON');
      button.innerText = 'X';
      button.addEventListener('click', function(evt) {
        var modelIndex = binding.unnamed.indexOf(elementBinding);
        binding.unnamed.splice(modelIndex, 1);
        binding.listPart.removeChild(elementBinding.element);
        binding.listPart.removeChild(button);
        binding.notifyChange();
      });

      binding.listPart.appendChild(button);
    };
  </script>
</class>

<class name="table.dynamic" native export>
  <script>
//console.log('Processing table dynamic');
    // The first tr inside a tbody will be treated as a template
    binding.tBody = null;
    binding.rowTemplate  = null;

    for (var i = 0; i < binding.element.tBodies.length; ++i) {
      binding.tBody = binding.element.tBodies[i];
      for (var j = 0; j < binding.tBody.rows.length; ++j) {
        binding.rowTemplate = binding.tBody.rows[j];
        binding.tBody.removeChild(binding.rowTemplate);
        break;        
      }
      if (binding.rowTemplate != null) {
        break;
      }
    }

    if (binding.rowTemplate == null) {
      console.log('Warning: Dynamic table is lacking a row template');
      return;
    }

    binding.setValue = function(v) {
      binding.tBody.innerHTML = '';
      binding.unnamed = [];

      function recurse(i) {
//console.log(i);
        if(i == 0) {
          return;
        }

        var newRow = binding.rowTemplate.cloneNode(true);
        var rowBinding = newBinding(newRow);
        binding.tBody.appendChild(newRow);

        interpretChildElements(newRow, namespace.newChildNamespace('TABLEITEM'))
          .then(function(bindings, scripts) {
//console.log(b);
//console.log(b);
            rowBinding.addToModel(bindings);
            rowBinding.setValue(v[v.length - i]);
            if ('delete' in binding.attributes) {
              binding.appendDeleteButton(rowBinding);
            }

            binding.unnamed.push(rowBinding);
            rowBinding.par = binding;
            rowBinding.addChangeListener(binding.notifyChange);

            recurse(i - 1);
          });
      };

      if (Array.isArray(v)) {
        recurse(v.length);
      }
    };
    binding.getValue = function() {
      var result = [];
      for (var i = 0; i < binding.unnamed.length; ++i) {
        result.push(binding.unnamed[i].getValue());
      }
      return result;
    };

    binding.appendDeleteButton = function(rowBinding) {
      var button = document.createElement('BUTTON');
      button.innerText = 'X';
      button.addEventListener('click', function(evt) {
        var modelIndex = binding.unnamed.indexOf(rowBinding);
        binding.unnamed.splice(modelIndex, 1);
        binding.tBody.removeChild(rowBinding.element);
        binding.notifyChange();
      });

      var cell = rowBinding.element.insertCell();
      cell.appendChild(button);
    };

    if ('add' in binding.attributes) {
      var addBody = document.createElement('TBODY');
      if (binding.tBody.nextElementSibling == null) {
        binding.element.appendChild(addBody);
      } else {
        binding.element.insertBefore(addBody, binding.tBody.nextElementSibling);
      }
      var row = addBody.insertRow();
      var cell = row.insertCell();
      cell.colSpan = 100;
      cell.style.textAlign = 'CENTER';
      var button = document.createElement('BUTTON');
      button.innerText = 'Add';
      cell.appendChild(button);
      cell.addEventListener('click', function(evt) {
        var newRow = binding.rowTemplate.cloneNode(true);
        var rowBinding = newBinding(newRow);
        binding.tBody.appendChild(newRow);

        interpretChildElements(newRow, namespace.newChildNamespace('TABLEITEM'))
          .then(function(bindings, scripts) {
//console.log(b);
//console.log(b);
            rowBinding.addToModel(bindings);
            if ('delete' in binding.attributes) {
              binding.appendDeleteButton(rowBinding);
            }

            binding.unnamed.push(rowBinding);
            rowBinding.par = binding;
            rowBinding.addChangeListener(binding.notifyChange);
            rowBinding.focus();
          });

        binding.notifyChange();
      });
    }
  </script>
</class>

<class name="router" export>
  <class name="page">
    <content></content>
    <script>
      if ('src' in binding.attributes) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (xhttp.readyState == 4) {
            if (xhttp.status == 200) {
              binding.element.innerHTML = xhttp.responseText;

              // Remote resources should be evaluated in their own namespaces
              var pageNamespace = root.newChildNamespace('ROUTERPAGE');
              interpretChildElements(binding.element, pageNamespace)
                .then(function(bindings, scripts) {
                binding.addToModel(bindings);
                binding.runScripts(scripts);
                binding.setValueFromDataSource();
//console.log('Processing done');
              });
            } else {
              console.log('Error retrieving remote page: '
                + xhttp.status.toString());
            }
          }
        };
        xhttp.open('GET', binding.attributes.src + '?' + data.sessionId, true);
        xhttp.send();
      }
    </script>
  </class>
  <script>
//console.log('Processing script for router');
    var contentTag = document.createElement('CONTENT');

//console.log('About to interpret content');
    interpretTag(contentTag, namespace).then(function(bs, ss) {
//console.log('Done interpreting content');
//console.log(bs);
        // Copy the content binding model to the model for the tag itself
      binding.model = bs[0].model;
      binding.runScripts(ss);
      binding.setValueFromDataSource();
    });

    // Calling setValue on a router makes it show the specified page
    binding.setValue = function(pageName) {
      binding.element.innerHTML = '';

//console.log('Looking for page ' + pageName);
      if (pageName in binding.model) {
//console.log('Found page name');
        binding.element.appendChild(binding.model[pageName].element);
      } else if ('default' in binding.model) {
//console.log('Found default page 1');
        binding.element.appendChild(binding.model.default.element);
      } else {
        var defaultPage = null;
        for (var name in binding.model) {
          if ('default' in binding.model[name].attributes) {
            defaultPage = binding.model[name].element;
            break;
          }
        }

        if (defaultPage == null) {
          for (var i = 0; i < binding.unnamed.length; ++i) {
            if ('default' in binding.unnamed[i].attributes) {
              defaultPage = binding.unnamed[i].element;
              break;
            }
          }
        }

        if (defaultPage != null) {
//console.log('Found default page 2');
//console.log(binding);
          binding.element.appendChild(defaultPage);
        }
      }
    }

//console.log('Adding event listener');
    window.addEventListener('popstate', function(evt) {
      binding.setValue(document.location.hash.substr(1));
    });
  </script>
</class>
