<class name="input" native export>
  <script>
    //binding.element = document.createElement('INPUT');
    binding.setValue = function(v) {
      binding.element.value = v.toString();
    };
    binding.getValue = function() {
      return binding.element.value;
    };
    binding.element.addEventListener('focus', function(evt) {
      binding.valueOnFocus = binding.element.value;
    });
    binding.element.addEventListener('blur', function(evt) {
      if (binding.element.value != binding.valueOnFocus) {
        binding.notifyChange();
      }
    });
    binding.focus = function() {
      binding.element.focus();
    };
  </script>
</class>

<class name="literal" export>
  <script>
    binding.original = '';
    binding.setValue = function(v) {
      binding.original = v;
      binding.element.innerText = v.toString();
    };
    binding.getValue = function() {
      return binding.original;
    };
  </script>
</class>

<class name="list" export>
  <script>
    binding.listPart = document.createElement('SPAN');

    if ('add' in binding.attributes) {
      binding.listPart = document.createElement('SPAN');
      binding.addPart = document.createElement('SPAN');
      binding.element.appendChild(binding.listPart);
      binding.element.appendChild(binding.addPart);

      var contentTemplate = namespace.get('CONTENT');

      var button = document.createElement('BUTTON');
      button.innerText = '+';
      button.addEventListener('click', function(evt) {
        contentTemplate(null, null, null)
          .then(function(elementBinding) {
            binding.model.push(elementBinding);
            binding.listPart.appendChild(elementBinding.element);

            if ('delete' in binding.attributes) {
              binding.appendDeleteButton(elementBinding);
            }

            binding.notifyChange();
            elementBinding.focus();
          });
      });
      binding.addPart.appendChild(button);
    } else {
      binding.listPart = binding.element;
    }

    binding.model = [];
    binding.getValue = function() {
      var result = [];
      for (var i = 0; i < binding.model.length; ++i) {
        result.push(binding.model[i].getValue());
      }
      return result;
    };
    binding.setValue = function(v) {
      binding.model = [];
      binding.listPart.innerHTML = '';

      var contentTemplate = namespace.get('CONTENT');
      if (contentTemplate != null) {
        for (var i = 0; i < v.length; ++i) {
          if (('delimiter' in binding.attributes) && (i > 0)) {
            var span = document.createElement('SPAN');
            span.innerHTML = binding.attributes.delimiter;
            binding.listPart.appendChild(span);
          }

          contentTemplate(null, null, null)
            .then(function(elementBinding) {
              binding.model.push(elementBinding);
              binding.listPart.appendChild(elementBinding.element);
              elementBinding.setValue(v[i]);

              if ('delete' in binding.attributes) {
                binding.appendDeleteButton(elementBinding);
              }
            });
        }
      } else {
        binding.element.innerText = 'CONTENT is not defined';
      }
    };
    binding.appendDeleteButton = function(elementBinding) {
      var button = document.createElement('BUTTON');
      button.innerText = 'X';
      button.addEventListener('click', function(evt) {
        var modelIndex = binding.model.indexOf(elementBinding);
        binding.model.splice(modelIndex, 1);
        binding.listPart.removeChild(elementBinding.element);
        binding.listPart.removeChild(button);
        binding.notifyChange();
      });

      binding.listPart.appendChild(button);
    };
  </script>
</class>

<class name="table.dynamic" native export>
  <script>
    // The first tr inside a tbody will be treated as a template
    binding.tBody = null;
    binding.rowTemplate  = null;

    for (var i = 0; i < binding.element.tBodies.length; ++i) {
      binding.tBody = binding.element.tBodies[i];
      for (var j = 0; j < binding.tBody.rows.length; ++j) {
        binding.rowTemplate = binding.tBody.rows[j];
        binding.tBody.removeChild(binding.rowTemplate);
        break;        
      }
      if (binding.rowTemplate != null) {
        break;
      }
    }

    if (binding.rowTemplate == null) {
      return;
    }

    binding.model = [];
    binding.setValue = function(v) {
      binding.tBody.innerHTML = '';

      function recurse(i) {
//console.log(i);
        if(i == 0) {
          return;
        }
        var newRow = binding.rowTemplate.cloneNode(true);

        binding.tBody.appendChild(newRow);
        processOneElement(newRow, binding, namespace.new()).then(function(b) {
//console.log(b);
          if (b != null) {
//console.log(b);
            binding.model.push(b);
            b.setValue(v[v.length - i]);
            if ('delete' in binding.attributes) {
              binding.appendDeleteButton(b);
            }
          }
          recurse(i - 1);
        });
      };

      if (Array.isArray(v)) {
        recurse(v.length);
      }
    };
    binding.getValue = function() {
      var result = [];
      for (var i = 0; i < binding.model.length; ++i) {
        result.push(binding.model[i].getValue());
      }
      return result;
    };

    binding.appendDeleteButton = function(rowBinding) {
      var button = document.createElement('BUTTON');
      button.innerText = 'X';
      button.addEventListener('click', function(evt) {
        var modelIndex = binding.model.indexOf(rowBinding);
        binding.model.splice(modelIndex, 1);
        binding.tBody.removeChild(rowBinding.element);
        binding.notifyChange();
      });

      var cell = rowBinding.element.insertCell();
      cell.appendChild(button);
    };

    if ('add' in binding.attributes) {
      var addBody = document.createElement('TBODY');
      if (binding.tBody.nextElementSibling == null) {
        binding.element.appendChild(addBody);
      } else {
        binding.element.insertBefore(addBody, binding.tBody.nextElementSibling);
      }
      var row = addBody.insertRow();
      var cell = row.insertCell();
      cell.colSpan = 100;
      cell.style.textAlign = 'CENTER';
      var button = document.createElement('BUTTON');
      button.innerText = 'Add';
      cell.appendChild(button);
      cell.addEventListener('click', function(evt) {
        var newRow = binding.rowTemplate.cloneNode(true);

        binding.tBody.appendChild(newRow);
        processOneElement(newRow, binding, namespace.new()).then(function(b) {
          if (b != null) {
            binding.model.push(b);
            if ('delete' in binding.attributes) {
              binding.appendDeleteButton(b);
            }
          }
        });
      });
    }
  </script>
</class>

<class name="router" export>
  <class name="page">
    <script>
      if ('src' in binding.attributes) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (xhttp.readyState == 4) {
            if (xhttp.status == 200) {
              binding.element.innerHTML = xhttp.responseText;

              // Remote resources should be evaluated in their own namespaces
              var pageNamespace = root.new();
              processChildElements(binding.element, binding, pageNamespace)
                .then(function(b) {
//console.log('Processing done');
              });
            } else {
              console.log('Error retrieving remote page: '
                + xhttp.status.toString());
            }
          }
        };
        xhttp.open('GET', binding.attributes.src, true);
        xhttp.send();
      }
    </script>
  </class>
  <script>
    // Process the content and copy the content binding model to the model
    // for the tag itself
    var contentInterpreter = namespace.get('CONTENT');
    if (contentInterpreter != null) {
      contentInterpreter(null, null, null).then(function(b) {
        binding.model = b.model;
      });
    }

    // Calling setValue on a router makes it show the specified page
    binding.setValue = function(pageName) {
      binding.element.innerHTML = '';

      if (pageName in binding.model) {
        binding.element.appendChild(binding.model[pageName].element);
      } else if ('default' in binding.model) {
        binding.element.appendChild(binding.model.default.element);
      }
    }

    window.addEventListener('popstate', function(evt) {
      binding.setValue(document.location.hash.substr(1));
    });
  </script>
</class>
